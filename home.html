<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SecureVault - Home</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <!-- Material Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />

  <link rel="stylesheet" href="css/common.css" />
  <script type="text/javascript" src="js/app.js"></script>
  
  <style>

    * {
      box-sizing: border-box;
    }

    /* Header */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--header-height);
      background-color: var(--card-color);
      border-bottom: 1px solid #023f68;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary-color);
      font-weight: 600;
      font-size: 20px;
      z-index: 1001;
      user-select: none;
      padding: 30px 10px 0 10px;
    }

    /* Hamburger */
    #hamburger {
      position: fixed;
      top: 45px;
      left: 16px;
      cursor: pointer;
      color: var(--primary-color);
      font-size: 28px;
      z-index: 1100;
      transition: color 0.2s ease;
    }

    #hamburger:hover {
      color: var(--secondary-color);
      text-decoration:none;
    }

    /* Side panel */
    #sidePanel {
      position: fixed;
      top: var(--header-height);
      left: -var(--sidepanel-width);
      width: var(--sidepanel-width);
      height: calc(100vh - var(--header-height));
      background-color: var(--card-color);
      box-shadow: 2px 0 8px rgba(0,0,0,0.6);
      transition: left 0.3s ease;
      padding-top: 20px;
      z-index: 1050;
      display: flex;
      flex-direction: column;
    }

    #sidePanel.open {
      left: 0;
    }

    #sidePanel a {
      padding: 14px 24px;
      color: var(--text-color);
      font-weight: 600;
      text-decoration: none;
      font-size: 16px;
      border-left: 4px solid transparent;
      transition: background-color 0.2s ease, border-color 0.2s ease;
      user-select: none;
    }

    #sidePanel a:hover,
    #sidePanel a.active {
      background-color: var(--primary-color);
      border-left: 4px solid var(--secondary-color);
      color: #fff;
    }
	
	#sidePanel {
	  left: -220px;  /* hide off screen */
	  transition: left 0.3s ease;
	}
	#sidePanel.open {
	  left: 0;
	}

    /* Main content wrapper */
    main {
      margin-top: var(--header-height);
      padding: 24px 16px;
      transition: margin-left 0.3s ease;
      margin-left: 0;
    }

    main.shifted {
      margin-left: var(--sidepanel-width);
    }

    /* Search Box */
    .search-box {
      max-width: 400px;
      margin-bottom: 24px;
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 12px 40px 12px 16px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #222;
      background-color: #073353;
      color: var(--text-color);
      outline: none;
      transition: border-color 0.2s ease;
    }

    .search-box input::placeholder {
      color: var(--muted-text);
    }

    .search-box .material-icons {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted-text);
    }

    /* Cards Grid */
    .cards-container {
      max-width: 960px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }

    /* Card */
    .card {
      background-color: var(--card-color);
      border-radius: 20px;
      padding: 20px 24px;
      cursor: default;
      display: flex;
      flex-direction: column;
      transition: background-color 0.2s ease;
      box-shadow: none;
    }

    .card:hover {
      background-color: #154a73;
    }

    /* Add this or update your existing card styles */

	/* Card Colors by type */
  .card.credit {
    background: linear-gradient(135deg, #1565c0 0%, #0288d1 100%);
    box-shadow: 0 4px 15px rgba(2, 136, 209, 0.6);
  }

  .card.debit {
    background: linear-gradient(135deg, #00897b 0%, #26a69a 100%);
    box-shadow: 0 4px 15px rgba(38, 166, 154, 0.6);
  }

  .card.netbanking {
    background: linear-gradient(135deg, #6a1b9a 0%, #8e24aa 100%);
    box-shadow: 0 4px 15px rgba(142, 36, 170, 0.6);
  }

  .card.login {
    background: linear-gradient(135deg, #914b01 0%, #ca6902 100%);
    box-shadow: 0 4px 15px rgba(96, 125, 139, 0.6);
  }

  .card.reminder {
    background: linear-gradient(135deg, #74022d 0%, #97023b 100%);
    box-shadow: 0 4px 15px rgba(96, 125, 139, 0.6);
  }

  .card.other {
    background: linear-gradient(135deg, #067c06 0%, #06be06 100%);
    box-shadow: 0 4px 15px rgba(96, 125, 139, 0.6);
  }

  .card {
    border-radius: 20px;
    padding: 20px 24px;
    cursor: default;
    display: flex;
    flex-direction: column;
    color: #e0f7fa;
    user-select: text;
  }

  .card-type-brand {
    font-weight: 700;
    font-size: 18px;
    margin-bottom: 12px;
    user-select: none;
    letter-spacing: 1.2px;
    text-transform: uppercase;
  }

  .card-number {
    font-size: 24px;
    font-weight: 700;
    letter-spacing: 3px;
    margin-bottom: 18px;
    user-select: text;
  }

  .label-small {
    font-size: 12px;
    font-weight: 600;
    opacity: 0.7;
    user-select: none;
  }

  .card-holder-name,
  .bank-name {
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 14px;
    user-select: text;
  }

  hr.card-divider {
    border: 0;
    border-top: 1px solid rgba(224, 247, 250, 0.3);
    margin: 12px 0 14px 0;
  }

  .description {
    font-size: 14px;
    font-weight: 600;
    opacity: 0.8;
    user-select: none;
  }

  /* Important details pop out */
  .card-detail.important {
    font-weight: 700;
    font-size: 18px;
    color: var(--secondary-color);
    margin-bottom: 10px;
    user-select: text;
  }
  
  /* Floating button */
  .floating-button {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background-color: var(--secondary-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      cursor: pointer;
      transition: background-color 0.3s ease;
      z-index: 1000;
  }

  .floating-button:hover {
      background-color: #0097a7;
  }

</style>

</head>
<body>

  <header>
    <div id="hamburger" title="Menu" tabindex="0" role="button" aria-label="Toggle menu">
      <span class="material-icons">menu</span>
    </div>
    Vault
  </header>

  <nav id="sidePanel" aria-label="Main menu">
    <a href="home.html" class="active" tabindex="0">Home</a>
    <a href="profile.html" tabindex="0">Profile</a>
    <a href="#" onclick="javascript: exportData()" tabindex="0">Export</a>
    <a href="changepass.html" tabindex="0">Reset Password</a>
    <a href="setting.html" tabindex="0">Settings</a>
    <a href="index.html" tabindex="0">Logout</a>
  </nav>

  <main id="mainContent">
    <div class="search-box">
      <input type="search" id="searchInput" placeholder="Search cards..." aria-label="Search cards" />
      <span class="material-icons" aria-hidden="true">search</span>
    </div>

    <div class="cards-container" id="cardsContainer">
      <!-- Cards injected here -->
    </div>

    <button class="floating-button" onclick="addItem()">
        <i class="material-icons">add</i>
    </button>
  </main>

  <!-- Loader -->
  <div id="loaderOverlay" class="loader-overlay">
    <div class="loader-spinner"></div>
  </div>

  <script>
    var cardData = [];
    
    function cardClick(event, ctrlReff) {

      const containerTop = ctrlReff.getBoundingClientRect().top;
      const y  = parseInt(event.pageY) - parseInt(containerTop);
      
      sessionStorage.yPosition = y;
      var type = ctrlReff.getAttribute("type");
      var dataId = ctrlReff.getAttribute("dataid");
      window.location.href = "add.html?id=" + dataId + "&type=" + type;
    }

    function addItem() {
      window.location.href = "add.html";
    }

    window.addEventListener('load', async () => {

      if(window.Capacitor) {

        Capacitor.Plugins.App.addListener('backButton', ({ canGoBack }) => {
          if(canGoBack) {
            console.log("Reloading page");
            window.location.reload();
          } else {
            console.log("Can not log back");
          }
        });

        try {

          showLoader();

          if(sessionStorage.isAuthenticated == undefined || sessionStorage.isAuthenticated == false) {
            window.location.href = "index.html";
          }

          sidePanel.classList.remove('open');
          mainContent.classList.remove('shifted');          

          const [creditCardValues, debitCardValues, netbankingsValues, loginsValues, reminderValues] = await Promise.all([
            getJSONPref("CreditCards"),
            getJSONPref("DebitCards"),
            getJSONPref("Netbankings"),
            getJSONPref("Logins"),
            getJSONPref("Reminders"),
          ]);

          creditCardValues?.data?.length > 0 ? cardData.push(...creditCardValues.data) : '';
          debitCardValues?.data?.length > 0 ? cardData.push(...debitCardValues.data) : '';
          netbankingsValues?.data?.length > 0 ? cardData.push(...netbankingsValues.data) : '';
          loginsValues?.data?.length > 0 ? cardData.push(...loginsValues.data) : '';
          reminderValues?.data?.length > 0 ? cardData.push(...reminderValues.data) : '';
          
          // Initial render
          renderCards();
          hideLoader();

          setTimeout(()=> {
            if(sessionStorage.yPosition) {
              window.scrollTo({top: parseInt(sessionStorage.yPosition), behavior: 'smooth'}) 
            }
          }, 200);

        } 
        catch(error) 
        {
          await showMessage("Crashed !", error.message);
          hideLoader();
        }
      }
      else {
        await showMessage('Crashed !', 'Error while loading capacitor plugins. Please contact application developer.');
      }
    });

    function onLongPress(element, callback, delay = 600, moveTolerance = 10) {
      let timer;
      let startX = 0;
      let startY = 0;
      let isTouch = false;
      let moved = false;

      const start = (e) => {
        moved = false;
        isTouch = e.type.startsWith('touch');
        const point = isTouch ? e.touches[0] : e;
        startX = point.clientX;
        startY = point.clientY;

        timer = setTimeout(() => {
          if (!moved) {
            callback(e);
          }
        }, delay);
      };

      const move = (e) => {
        const point = isTouch ? e.touches[0] : e;
        const deltaX = Math.abs(point.clientX - startX);
        const deltaY = Math.abs(point.clientY - startY);
        if (deltaX > moveTolerance || deltaY > moveTolerance) {
          moved = true;
          clearTimeout(timer);
        }
      };

      const cancel = () => {
        clearTimeout(timer);
      };

      // Mouse events
      element.addEventListener('mousedown', start);
      element.addEventListener('mousemove', move);
      element.addEventListener('mouseup', cancel);
      element.addEventListener('mouseleave', cancel);

      // Touch events
      element.addEventListener('touchstart', start, { passive: true });
      element.addEventListener('touchmove', move, { passive: true });
      element.addEventListener('touchend', cancel);
      element.addEventListener('touchcancel', cancel);
    }

    const hamburger = document.getElementById('hamburger');
    const sidePanel = document.getElementById('sidePanel');
    const mainContent = document.getElementById('mainContent');

    // Ensure menu is closed initially
    sidePanel.classList.remove('open');
    mainContent.classList.remove('shifted');

    hamburger.addEventListener('click', () => {
      sidePanel.classList.toggle('open');
      mainContent.classList.toggle('shifted');
    });

    // Accessibility: allow keyboard toggle for hamburger
    hamburger.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        hamburger.click();
      }
    });

    // Close menu if click outside side panel or hamburger
    document.addEventListener('click', (e) => {
      if (
        sidePanel.classList.contains('open') &&
        !sidePanel.contains(e.target) &&
        !hamburger.contains(e.target)
      ) {
        sidePanel.classList.remove('open');
        mainContent.classList.remove('shifted');
      }
    });

    // Close menu on Escape key press
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && sidePanel.classList.contains('open')) {
        sidePanel.classList.remove('open');
        mainContent.classList.remove('shifted');
      }
    });

    const cardsContainer = document.getElementById('cardsContainer');
    const searchInput = document.getElementById('searchInput');

    function renderCards(filter = '') {
      const searchTerm = filter.toLowerCase();
      cardsContainer.innerHTML = '';

      const filteredCards = cardData.filter(card => {
        if(!card) return false;
        return Object.values(card).some(val => String(val).toLowerCase().includes(searchTerm));
      });

      if (filteredCards.length === 0) {
        cardsContainer.innerHTML = '<p>No matching cards found.</p>';
        return;
      }

      filteredCards.forEach(card => {
        // Determine card class based on type
        let cardClass = 'other';
        if (card.type.toLowerCase().includes('credit')) cardClass = 'credit';
        else if (card.type.toLowerCase().includes('debit')) cardClass = 'debit';
        else if (card.type.toLowerCase().includes('netbanking')) cardClass = 'netbanking';
        else if (card.type.toLowerCase().includes('login')) cardClass = 'login';
        else if (card.type.toLowerCase().includes('reminder')) cardClass = 'reminder';

        const cardEl = document.createElement('div');
        cardEl.className = `card ${cardClass}`;
        cardEl.setAttribute('onclick', 'cardClick(event, this)');

        onLongPress(cardEl, async (ele) => {

          var cardElement = ele.target.closest('.card');

          var typeId = cardElement.getAttribute("type");
          var dataId = cardElement.getAttribute("dataid");

          const key = getStorageKeyFromType(parseInt(typeId));

          const result = await Capacitor.Plugins.ActionSheet.showActions({
            title: 'Delete the selected items',
            options: [
              {
                title: 'Delete',
                style: 'Destructive',
              },
              {
                  title:'Cancel'
              }
            ],
          });

          if(result.index == 0) { 

            var storedValues = await Capacitor.Plugins.Preferences.get({
              key: key
            });

            var oldDataBasedOnKey = JSON.parse(storedValues.value); 

            oldDataBasedOnKey.data = oldDataBasedOnKey.data.filter(x=>x.id !== parseInt(dataId));

            await Capacitor.Plugins.Preferences.set({
              key: key,
              value : JSON.stringify(oldDataBasedOnKey)
            });

            await showMessage('Success !', 'Card deleted successfully.');

            window.location.reload();
          }

        });

        let index = 0;
        switch(card.type)
        {
          case "Credit Card":
            index = 0;
            break;
          case "Debit Card":
            index = 1;
            break;
          case "Netbanking":
            index = 2;
            break;
          case "Login":
            index = 3;
            break;
          case "Reminder":
            index = 4;
            break;
        }
        
        cardEl.setAttribute('type', index);
        
        cardEl.setAttribute('dataId', card.id);

        cardEl.innerHTML = `
        <div class="card-type-brand">${ card.type =='Login' ? (card.type + ' -  ' + card.name) : (card.type == 'Netbanking' ? card.type : (card.type == 'Reminder' ? card.type : (card.type + ' - ' + card.cardType))) }</div>
        ${
          card.type == "Login" ? '' : '<div class="card-number">' + (card.type == 'Netbanking' ? card.accountNo : (card.type == 'Reminder' ? card.titleName : formatCardNumber(card.cardNo))) + '</div>'
        }
        <div>
          <table width="100%">
            <tr>
              <td style="text-align: left;">
                <div class="label-small">${ card.type == 'Login' ? 'Name' : (card.type == 'Reminder' ? 'Start Date' : 'Card Holder')} </div>
                <div class="card-holder-name">${card.type == 'Login' ? card.userId : (card.type == 'Reminder' ? card.startDate : card.name) }</div>
              </td>
            ${ card.type == 'Login' ? '' :  
              `<td>
                <div class="label-small">${ card.type == 'Reminder' ? 'End Date' :  'Bank'}</div>
                <div class="bank-name">${card.type == 'Reminder' ? card.endDate : card.bankName}</div>	
              </td>`
            }
            </tr>
            ${ card.type == 'Login' ? 
            `<tr>
              <td colspan="2">
                <div class="label-small">Password</div>
                <div class="bank-name">${ maskLastSixChars(card.loginPassword) }</div>              
              </td>
            </tr>` : ''
            }

            ${card.type == 'Reminder' ? 
              `<tr>
                <td colspan="2">
                  <div class="label-small">Reminder Date</div>
                  <div class="bank-name">${ card.reminderDate }</div>              
                </td>
              </tr>
              <tr>
                <td colspan="2">
                  <div class="label-small">Push notification message</div>
                  <div class="bank-name">${ card.pushNotiMessage }</div>              
                </td>
              </tr>`: ''
            }

          </table>
        </div>
        <hr class="card-divider" />

        <div class="description">${card.description}</div>
        `;

        cardsContainer.appendChild(cardEl);
      });
	  }

    searchInput.addEventListener('input', (e) => {
      renderCards(e.target.value);
    });

  </script>

</body>
</html>
